// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enable PostGIS extension
// Run: CREATE EXTENSION IF NOT EXISTS postgis;

model User {
  id            String        @id @default(uuid())
  email         String?       @unique
  phone         String?       @unique
  passwordHash  String?
  role          UserRole      @default(USER)
  actif         Boolean       @default(true)
  country       String?       // Code pays ISO (ex: SN, FR, CI, etc.)
  address       String?
  latitude      Float?
  longitude     Float?
  location      Unsupported("geometry(Point,4326)")? // PostGIS Point
  consentements Json?         // Consentements RGPD
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  prestataire   Prestataire?
  demandes      Demande[]
  commandes     Commande[]
  avis          Avis[]

  @@map("users")
}

enum UserRole {
  USER
  PRESTATAIRE
  ADMIN
}

model Prestataire {
  id              String              @id @default(uuid())
  userId          String              @unique
  raisonSociale   String
  description     String?
  logoUrl         String?
  kycStatut       KycStatut           @default(EN_ATTENTE)
  kycDocuments    Json?               // Documents KYC (URLs)
  noteMoyenne     Float               @default(0)
  nombreAvis      Int                 @default(0)
  zonesGeo        Unsupported("geometry(MultiPolygon,4326)")? // PostGIS zones
  disponibilite   Boolean             @default(true)
  abonnementActif Boolean             @default(false)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  abonnements       Abonnement[]
  prestataireServices PrestataireService[]
  commandes         Commande[]
  avis              Avis[]
  travauxRecents    PrestataireWork[]

  @@map("prestataires")
  @@index([abonnementActif])
  @@index([noteMoyenne])
}

enum KycStatut {
  EN_ATTENTE
  VALIDE
  REJETE
}

model Secteur {
  id          String         @id @default(uuid())
  nom         String
  slug        String         @unique
  description String?
  actif       Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  sousSecteurs SousSecteur[]

  @@map("secteurs")
}

model SousSecteur {
  id          String    @id @default(uuid())
  secteurId   String
  nom         String
  slug        String    @unique
  description String?
  actif       Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  secteur     Secteur   @relation(fields: [secteurId], references: [id], onDelete: Cascade)
  services    Service[]

  @@map("sous_secteurs")
  @@index([secteurId])
}

model Service {
  id            String    @id @default(uuid())
  sousSecteurId String
  nom           String
  slug          String    @unique
  description   String?
  attributs     Json?     // Durée, indoor/outdoor, équipement, etc.
  actif         Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sousSecteur           SousSecteur          @relation(fields: [sousSecteurId], references: [id], onDelete: Cascade)
  prestataireServices   PrestataireService[]
  demandes              Demande[]

  @@map("services")
  @@index([sousSecteurId])
  @@index([actif])
}

model PlanAbonnement {
  id          String            @id @default(uuid())
  nom         String
  type        TypeAbonnement
  prix        Float
  actif       Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  abonnements Abonnement[]

  @@map("plans_abonnement")
  @@index([type, actif])
}

enum TypeAbonnement {
  MENSUEL
  ANNUEL
}

model Abonnement {
  id          String            @id @default(uuid())
  prestataireId String
  planId      String?           // Optionnel si tarif custom
  type        TypeAbonnement
  dateDebut   DateTime
  dateFin     DateTime
  statut      StatutAbonnement  @default(EN_ATTENTE)
  tarif       Float
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  prestataire Prestataire       @relation(fields: [prestataireId], references: [id], onDelete: Cascade)
  plan        PlanAbonnement?   @relation(fields: [planId], references: [id])
  paiements   Paiement[]

  @@map("abonnements")
  @@index([prestataireId])
  @@index([statut])
  @@index([dateFin])
}

enum StatutAbonnement {
  ACTIF
  EXPIRE
  EN_ATTENTE
}

model Paiement {
  id                String            @id @default(uuid())
  abonnementId      String
  prestataireId     String
  methode           MethodePaiement
  montant           Float
  statut            StatutPaiement    @default(EN_ATTENTE)
  referenceExterne  String?           // TransactionId Wave/Orange
  justificatifUrl   String?           // Pour paiements espèces
  valideParAdminId  String?           // Admin qui a validé
  dateValidation    DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  abonnement        Abonnement        @relation(fields: [abonnementId], references: [id], onDelete: Cascade)

  @@map("paiements")
  @@index([prestataireId])
  @@index([statut])
  @@index([methode])
  @@index([referenceExterne])
}

enum MethodePaiement {
  WAVE
  ORANGE_MONEY
  ESPECES
}

enum StatutPaiement {
  EN_ATTENTE
  VALIDE
  REJETE
}

model PrestataireService {
  id              String   @id @default(uuid())
  prestataireId   String
  serviceId       String
  tarifIndicatif  Float?
  delai           Int?     // En heures/jours
  description     String?
  actif           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  prestataire     Prestataire @relation(fields: [prestataireId], references: [id], onDelete: Cascade)
  service         Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("prestataire_services")
  @@unique([prestataireId, serviceId])
  @@index([prestataireId])
  @@index([serviceId])
}

model PrestataireWork {
  id            String      @id @default(uuid())
  prestataireId String
  imageUrl      String
  titre         String?
  description   String?
  createdAt     DateTime   @default(now())

  prestataire   Prestataire @relation(fields: [prestataireId], references: [id], onDelete: Cascade)

  @@map("prestataire_works")
  @@index([prestataireId, createdAt])
}

model Demande {
  id            String          @id @default(uuid())
  utilisateurId String
  serviceId     String
  zone          String?         // Description zone
  latitude      Float?
  longitude     Float?
  location      Unsupported("geometry(Point,4326)")?
  description   String?
  statut        StatutDemande   @default(EN_ATTENTE)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  utilisateur   User            @relation(fields: [utilisateurId], references: [id], onDelete: Cascade)
  service       Service         @relation(fields: [serviceId], references: [id])
  commandes     Commande[]

  @@map("demandes")
  @@index([utilisateurId])
  @@index([serviceId])
  @@index([statut])
}

enum StatutDemande {
  EN_ATTENTE
  ACCEPTEE
  REFUSEE
  ANNULEE
}

model Commande {
  id            String          @id @default(uuid())
  demandeId     String
  prestataireId String
  utilisateurId String
  statut        StatutCommande @default(EN_ATTENTE)
  rdvAt         DateTime?       // Date/heure rendez-vous
  prix          Float?
  transactions  Json?           // Informations transactions
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  demande       Demande         @relation(fields: [demandeId], references: [id], onDelete: Cascade)
  prestataire   Prestataire     @relation(fields: [prestataireId], references: [id])
  utilisateur   User            @relation(fields: [utilisateurId], references: [id])
  avis          Avis?

  @@map("commandes")
  @@index([demandeId])
  @@index([prestataireId])
  @@index([utilisateurId])
  @@index([statut])
  @@unique([demandeId]) // Une commande par demande
}

enum StatutCommande {
  EN_ATTENTE
  ACCEPTEE
  EN_COURS
  TERMINEE
  ANNULEE
}

model Avis {
  id          String    @id @default(uuid())
  commandeId  String    @unique
  prestataireId String
  utilisateurId String
  note        Int       // 1-5
  commentaire String?
  visible     Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  commande    Commande  @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  prestataire Prestataire @relation(fields: [prestataireId], references: [id])
  utilisateur User      @relation(fields: [utilisateurId], references: [id])

  @@map("avis")
  @@index([prestataireId])
  @@index([note])
  @@index([visible])
  @@index([commandeId])
}

model AdminAction {
  id        String        @id @default(uuid())
  type      String        // Type d'action (VALIDATION_PRESTATAIRE, MODERATION_AVIS, etc.)
  cibleId   String        // ID de l'entité concernée
  adminId   String        // ID de l'admin
  meta      Json?         // Métadonnées supplémentaires
  createdAt DateTime      @default(now())

  @@map("admin_actions")
  @@index([type])
  @@index([cibleId])
  @@index([createdAt])
}

